<div class="row">
	<div class="col-lg-12">
	<form th:object="${salesInvoiceForm}" id="salesInvoiceForm"
			th:action="@{/api/sales/invoice}" method="POST">
	
		<div class="panel panel-default">
			<div class="panel-heading">
				<div class="row ">
					<div class="col-md-4 col-md-offset-8 btn-group" role="group">
						<button type="submit" id="submitSalesInvoiceBtn"
							class="btn btn-success btn-sm">Save Sales Invoice</button>
						<a th:href="@{/sales/invoice}" class="btn btn-default btn-sm">Cancel</a>
					</div>
				</div>
			</div>
			<div class="panel-body">
			
				<div class="form-group" id="errors"></div>

				<div class="table-responsive">
				
					<table class="table table-bordered table-striped">
						<tbody>
							<tr>
								<td>
									<div class="input-group">
										<span class="input-group-addon">Trans. Date</span>
										<input type="text" th:field="*{transactionDate}" class="form-control">
									</div>
								</td>
								<td class="col-md-2">
									<div class="input-group">
										<span class="input-group-addon">Year</span>
										 <input type="text" class="form-control yearselect" th:field="*{year}" />
									</div>
								</td>
								<td class="col-md-4">
									<div class="input-group">
										<span class="input-group-addon">Sales Person</span>
										<select
												class="form-control" th:field="*{salesPerson}">
												<option th:each="user : ${users}"
													th:value="${user.id}" th:text="${user.lastName} + ', ' + ${user.firstName}"></option>
											</select>
									</div>
								</td>
							</tr>
							
							<tr>
								<td class="col-md-4">
								
									<div class="input-group col-md-12">
										<span class="input-group-addon">Document #</span>
										 <input	type="text" th:field="*{documentNumber}"
												class="form-control">
									</div>
								</td>
								
								<td colspan="2">
									<div class="input-group col-md-12">
										<span class="input-group-addon">Location</span>
										<select
												class="form-control" th:field="*{location}">
												<option th:each="location : ${locations}"
													th:value="${location.id}" th:text="${location.name}"></option>
											</select>
									</div>
								</td>
							</tr>
							
							<tr>
								<td colspan="3">
									<div class="input-group col-md-12">
										<span class="input-group-addon">Description</span>
										<input
												type="text" th:field="*{description}" class="form-control">
									</div>
								</td>
							</tr>
						</tbody>
					</table>
						
					<table class="table table-bordered table-striped" id="itemsTable">
						<thead>
							<tr>
								<th>SN</th>
								<th>Code</th>
								<th class="col-md-3">Description</th>
								<th>Unit</th>
								<th>U.Desc</th>
								<th>Quantity</th>
								<th>Unit Price</th>
								<th  class="col-md-2">Amount</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							
						</tbody>
						<tfoot>
							<tr>
								<th colspan="6"></th>
								<th><h3>Total<h3></h3></th>
								<th><h3 class="text-right" id="grandTotal"></h3></th>
								<th></th>
							</tr>
						</tfoot>
					</table>
					
				</div>
				
				<div class="row">
					<div class="col-md-4">
						<button class="btn btn-success btn-sm" id="btnAddItem">Add
							Item</button>
					</div>
				</div>

			</div>
		</div>
		
		<div class="col-lg-6">
			<div class="panel panel-info">
			    <div class="panel-heading">
			    	Customer Information
			    	
			    	<button type="button" class="btn btn-success btn-xs pull-right">Add Customer</button>
			    </div>
			    <div class="panel-body">
			    
			    	<table class="table table-bordered table-striped">
						<tbody>
							<tr>
								<th>
									<div class="input-group">
										<span class="input-group-addon">Customer</span>
										<select
												class="form-control" th:field="*{customer}">
												<option th:each="user : ${users}"
													th:value="${user.id}" th:text="${user.lastName} + ', ' + ${user.firstName}"></option>
											</select>
									</div>
								</th>
							</tr>
							<tr>
								<th>
									<div class="input-group">
										<span class="input-group-addon">Address</span>
										
									</div>
								</th>
							</tr>
							<tr>
								<th>
									<div class="input-group">
										<span class="input-group-addon">Phone</span>
										
									</div>
								</th>
							</tr>
						</tbody>
					</table>
			    </div>
			</div>
		</div>
		<div class="col-lg-6">
			<div class="panel panel-warning">
			    <div class="panel-heading">
			        Payment Method
			        
			        <button type="button" class="btn btn-success btn-xs pull-right" id="updatePaymentMethodBtn">Update Payment Method </button>
			    </div>
			    <div class="panel-body">
			    	<div id="paymentMethod">
			    		<p>There are no payment method selected</p>
			    	</div>
			        
			    </div>
			</div>
		</div>
		</form>
	</div>
	<!-- /.col-lg-12 -->
</div>

<script type="text/javascript">
$( function() {
	$( "#transactionDate" ).datepicker();
	
    $('.yearselect').yearselect({
    	order: 'desc',	
 		start: current_year - 5,
 		end: current_year + 5
    });
    
    $('[name=year]').val( current_year );
});
</script>

<!-- Item Modal -->
<div th:include="includes/modals/itemModal"></div>

<script>
/*<![CDATA[*/
var form = $("#salesInvoiceForm");
var grand_total = 0;

var item_count = 0;
var current_year = (new Date()).getFullYear();
var submitSalesInvoiceBtn = $("#submitSalesInvoiceBtn");

$("#btnAddItem").on("click", function() {
  	addItem({type: "sales_invoice", label:"Add Sales Invoice Item"}, function(data) {
  		
  		var item = data['item'];
  		var unit = data['unit'];
  		
  		var total = data.quantity * data.unit_cost;
  		grand_total = grand_total + total;
  		
  		var html = `
  		<tr>
				<th id="lblItemId">`+ item.id +`</th>
				<td id="lblItemCode">`+ item.code +`</td>
				<td id="lblItemName">`+ item.name +`</td>
				<td id="lblAbbreviation">`+ unit.abbreviation +`</td>
				<td id-"lblUnitName">`+ unit.name +`</td>
				<td class="text-right" id="lblQuantity">`+ data.quantity +`</td>
				<td class="text-right" id="lblUnitCost">`+ data.unit_cost +`</td>
				<td class="text-right" id="lblTotal">`+ total +`</td>
				<td class="text-right">
					<input type="hidden" name="salesInvoiceItems[`+ item_count +`].item" id="txtItem" value="` + item.id + `" />
					<input type="hidden" name="salesInvoiceItems[`+ item_count +`].unit" id="txtUnit" value="` + unit.id + `" />
					<input type="hidden" name="salesInvoiceItems[`+ item_count +`].quantity" id="txtQuantity" value="` + data.quantity + `" />
					<input type="hidden" name="salesInvoiceItems[`+ item_count +`].unitCost" id="txtUnitCost" value="` + data.unit_cost + `" />
					<div class="btn-group" role="group">
		        		<button class="btn btn-info fa fa-edit" id="btnView" onClick="edit(this)"/>
		        		<button class="btn btn-danger fa fa-times" onClick="remove(this)" />
		    		</div>
				</td>
			</tr>`;
			item_count++;

  		$('#itemsTable tbody').append(html);
  		$("#grandTotal").html(grand_total);
  	});
});

submitSalesInvoiceBtn.click(function() {
	  
  	var original_text = submitSalesInvoiceBtn.text();
  	submitSalesInvoiceBtn.attr("disabled", "disabled");
  	submitSalesInvoiceBtn.text("Processing....");
  	
  	POST("/api/sales/invoice", form.serialize(), function(data) {
  		console.log(data);
  		
  		if(data.status != "OK") {
  			displayErrors(data, $("#errors"));
  			submitSalesInvoiceBtn.removeAttr("disabled");
  			submitSalesInvoiceBtn.text(original_text);
  		} else {
  			window.location.replace('/sales/invoice')
  		}
  	});
  });

function edit(e) {
	var selected_row = $(e).parentsUntil("tbody");
	
	var values = {
		item: selected_row.find("#txtItem").val(),
		unit: selected_row.find("#txtUnit").val(),
		quantity: selected_row.find("#txtQuantity").val(),
		unit_cost: selected_row.find("#txtUnitCost").val()
	};
	
	var total = values.quantity * values.unit_cost;
	
	grand_total = grand_total - total;
	
	updateItem({type: "sales_invoice", label:"Edit Sales Invoice Item", values: values}, function(data) { 
		
		var item = data['item'];
		var unit = data['unit'];
		
		selected_row.find("#lblItemId").html(item.id);
		selected_row.find("#lblItemCode").html(item.code);
		selected_row.find("#lblItemName").html(item.name);
		selected_row.find("#lblUnitName").html(item.name);
		selected_row.find("#lblAbbreviation").html(item.name);
		
		selected_row.find("#txtItem").val(item.id);
		selected_row.find("#txtUnit").val(unit.id);
		selected_row.find("#txtQuantity").val(data.quantity);
		selected_row.find("#txtUnitCost").val(data.unit_cost);
		
		selected_row.find("#lblQuantity").html(data.quantity);
		selected_row.find("#lblUnitCost").html(data.unit_cost);
		selected_row.find("#lblTotal").html(data.quantity * data.unit_cost);
		
		computeGrandTotal(data.quantity, data.unit_cost); 
	});
}

function remove(e) {
	var selected_row = $(e).parentsUntil("tbody");
	var total = selected_row.find("#txtQuantity").val() * selected_row.find("#txtUnitCost").val()
	
	grand_total = grand_total - total;
	
	$(e).parentsUntil("tbody").remove();
	$("#grandTotal").html(grand_total);
}

function computeGrandTotal(quantity, unit_cost) {
	var total = quantity * unit_cost;
	grand_total = grand_total + total;
	$("#grandTotal").html(grand_total);
}
/*]]>*/
</script>

<!-- Payment Method Modal -->
<div th:include="includes/modals/paymentMethodModal"></div>

<script>
var updatePaymentMethodBtn = $("#updatePaymentMethodBtn");

updatePaymentMethodBtn.click(function() {
	
	updatePaymentMethod(function(data) { 
		
		console.log(data);
		
		var html = `
			<p class="text-center">`+ data.paymentMethod +`</p>
			<input type="hidden" name="paymentMethod" value="`+ data.paymentMethod +`" />
		`;
			
		if(data.paymentMethod == "CREDITCARD") {
			html = `
				<input type="hidden" name="paymentMethod" value="`+ data.paymentMethod +`" />
				<input type="hidden" name="creditCardDetails.holdersName" value="`+ data.creditCardHoldersName +`" />
				<input type="hidden" name="creditCardDetails.cardNumber" value="`+ data.creditCardNumber +`" />
				<input type="hidden" name="creditCardDetails.dateExpiry" value="`+ data.creditCardExpiry +`" />
				
			<div class="row">
                <div class="col-xs-12">
                    <div class="form-group">
                        <label for="cardExpiry">CARD HOLDERS NAME</label>
                        <span class="form-control">` + data.creditCardHoldersName + `</span>
                    </div>
                </div>
            </div>
			<div class="row">
				<div class="col-xs-12">
		            <div class="form-group">
		                <label for="cardNumber">CARD NUMBER</label>
		                <div class="input-group">
		                    <span class="form-control">` + data.creditCardNumber + `</span>
		                    <span class="input-group-addon"><i class="fa fa-credit-card"></i></span>
		                </div>
		            </div>                            
		        </div>
		    </div>
		    <div class="row">
		        <div class="col-xs-7 col-md-7">
		            <div class="form-group">
		                <label for="cardExpiry"><span class="hidden-xs">EXPIRATION</span><span class="visible-xs-inline">EXP</span> DATE</label>
		                <span class="form-control">`+ data.creditCardExpiry +`</span>
		            </div>
		        </div>
		    </div>`;
		}
		
		$("#paymentMethod").html(html);
	});
});
</script>