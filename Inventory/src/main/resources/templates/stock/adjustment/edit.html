<div class="row">
	<div class="col-lg-12">
		<form th:object="${stockAdjustmentForm}" id="stockAdjustmentForm"
			th:action="@{/api/stock/adjustment}" method="POST">

			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="row">
						<div class="col-md-8">
							<h4>New Stock Adjustment</h4>
						</div>
						<div class="col-md-4">
							<div class="btn-group pull-right" role="group">
								<button type="submit" id="submitStockAdjustmentBtn"
									class="btn btn-success btn-sm">Save Stock Adjustment</button>
								<a th:href="@{/stock/adjustment}" class="btn btn-default btn-sm">Cancel</a>
							</div>
						</div>
					</div>
				</div>
				<div class="panel-body">

					<div class="form-group" id="errors"></div>

					<div class="col-md-12">
						<div class="col-md-2">
							<label>Mode of Adjustment :</label>
						</div>
						<div class="col-md-10">
							<input type="radio" checked="checked" th:value="${T(com.bartolay.inventory.enums.StockAdjustmentType).QUANTITY}"
								id="adjustmentType" name="adjustmentType"> Quantity
							Adjustment<br> </label> <input type="radio" th:value="${T(com.bartolay.inventory.enums.StockAdjustmentType).COST}"
								id="adjustmentType" name="adjustmentType"> Cost
							Adjustment <br>
							<br>
						</div>

					</div>


					<div class="col-md-3">
						<label>System Number :</label> <input type="text"
							class="form-control" disabled="disabled"> <label>Document
							Number :</label> <input type="text" class="form-control"
							th:field="*{document_number}">
					</div>

					<div class="col-md-3">
						<label>Transaction Date</label> <input type="text"
							autocomplete="off" th:field="*{transactionDate}"
							class="form-control"> <label>Year</label> <input
							type="text" class="form-control yearselect" th:field="*{year}">
					</div>

					<div class="col-md-3">
						<label>Reason</label> <a href="#" id="manageReasons" class="pull-right"><span class="fa fa-gear"></span> Manage Reasons</a>
						<select class="form-control"
							th:field="*{reason}">
							<option value=""></option>
							<option th:each="reason : ${reasons}"
								th:value="${reason.id}" th:text="${reason.description}"></option>
						</select>
						<label>Location </label> <select class="form-control"
							th:field="*{location}">
							<option th:each="location : ${locations}"
								th:value="${location.id}" th:text="${location.name}"></option>
						</select>
					</div>
					<div class="col-md-12">
						<label>Description</label> <input type="text"
							th:field="*{description}" class="form-control">
					</div>
					<div class="col-md-12">
						<div class="row">
							<br>
							<div class="col-md-6">
								<button class="btn btn-success btn-sm" id="btnAddItem">Add	Item</button>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<br>
					
					<div class="table-responsive col-md-12">

						<table class="table table-bordered table-striped" id="itemsTable">
							<thead>
								<tr>
									<th>SN</th>
									<th class="col-md-1">Code</th>
									<th class="col-md-3">Description</th>
									<th>Unit</th>
									
									<th class="col-md-2 text-right hidden" id="quantity_1">Stock On Hand</th>
									<th class="col-md-2 text-right hidden" id="quantity_2">New Quantity On Hand</th>
									<th class="col-md-2 text-right hidden" id="quantity_3">Quantity Adjusted</th>
									
									
									<th class="col-md-2 text-right hidden" id="cost_1">Current Cost</th>
									<th class="col-md-2 text-right hidden" id="cost_2">Changed Cost</th>
									<th class="col-md-2 text-right hidden" id="cost_3">Adjusted Cost</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								
							</tbody>

						</table>

					</div>

				</div>
			</div>

		</form>
	</div>
	<!-- /.col-lg-12 -->
</div>

<!-- Item Modal -->
<div th:include="includes/modals/inventoryModal_by_location"></div>

<!-- Reasons Modal -->
<div th:include="includes/modals/stockAdjustment_reason"></div>

<!-- DataTables JavaScript -->
<script
	th:src="@{/static/vendor/datatables/js/jquery.dataTables.min.js}"></script>
<script
	th:src="@{/static/vendor/datatables-plugins/dataTables.bootstrap.min.js}"></script>
<script
	th:src="@{/static/vendor/datatables-responsive/dataTables.responsive.js}"></script>

<script>
var current_year = (new Date()).getFullYear();
var submitStockAdjustmentBtn = $("#submitStockAdjustmentBtn");
var stockAdjustmentForm = $("#stockAdjustmentForm");

$( function() {
	  
	formatAdjustmentType($('input[type=radio][name=adjustmentType]').val());
	
    $( "#transactionDate" ).datepicker();
    
    $('.yearselect').yearselect({
    	order: 'desc',	
 		start: current_year - 5,
 		end: current_year + 5
    });
    
    $('[name=year]').val( current_year );
  });
  
$('input[type=radio][name=adjustmentType]').change(function() {
	formatAdjustmentType(this.value);
});

function formatAdjustmentType(value) {
	 if (value == 'QUANTITY') {
		 $( "#cost_1, #cost_2, #cost_3" ).addClass( "hidden" );
		 $( "#quantity_1, #quantity_2, #quantity_3" ).removeClass( "hidden" );
    }
    else if (value == 'COST') {
    	$( "#cost_1, #cost_2, #cost_3" ).removeClass( "hidden" );
		$( "#quantity_1, #quantity_2, #quantity_3" ).addClass( "hidden" );
    }
}

function formatItemAdjustment(e) {
	var row = $(e).parentsUntil("tbody");
	
	var newCost = row.find("#newCost").val();
	var unit_cost = row.find("#unit_cost").val();
	var newQuantity = row.find("#newQuantity").val();
	var on_hand = row.find("#on_hand").val();
	
	var quantity_adjustment = row.find("#quantity_3");
	var cost_adjusment = row.find("#cost_3");
	
	var quantity = (newQuantity - on_hand);
	var cost = (newCost - unit_cost);
	
	quantity_adjustment.html("<strong>" + quantity + "</strong>");
	cost_adjusment.html("<strong>" + cost + "</strong>");
}
 
function remove(e) {
	$(e).parentsUntil("tbody").remove();
}

$("#manageReasons").on("click", function() {
	manageReasons({}, function(data) {
		/* console.log(data);
		console.log(data.description); */
		GET("/api/stock/adjustment/reasons", function(reasons){
			$("#reason option").remove();
			
			var html = "";
			
			for(var i = 0; i < reasons.length; i++) {
				var selected = reasons[i].description == data.description ? "selected" : "";
				html += `<option value="`+ reasons[i].id +`" `+ selected +`>`+ reasons[i].description +`</option>`;
			}
			
			$("#reason").html(html);
		});
	});
});

$("#btnAddItem").on("click", function() {
  	addInventory({
  			type: "stock_adjusment", 
  			location_id: $("#location").val()
  		}, function(data) {
  		
  		var html = ``;
  		for(var i = 0; i < data.length; i++) {
  			html += `
  			<tr>
  				<td>`+data[i].id+`
  					<input type="hidden" id="inventory" name="items[`+i+`].inventory" value="`+data[i].id+`" />"`+data[i].id+`"
  					<input type="hidden" id="on_hand" name="items[`+i+`].on_hand" value="`+data[i].on_hand+`" />
  					<input type="hidden" id="unit_cost" name="items[`+i+`].unit_cost" value="`+data[i].unit_cost+`" />
  				</td>
				<td class="col-md-1">`+data[i].item_code+`</td>
				<td class="col-md-3">`+data[i].item_name+`</td>
				<td>`+data[i].unit_name+`</td>
				
				<td class="col-md-2 text-right hidden" id="quantity_1">`+data[i].on_hand+`</td>
				<td class="col-md-2 text-right hidden" id="quantity_2"><input type="number" class="form-control input-sm" id="newQuantity" name="items[`+i+`].amount" onChange="formatItemAdjustment(this)" value="0"></td>
				<td class="col-md-2 text-right hidden" id="quantity_3">0</td>
				
				
				<td class="col-md-2 text-right hidden" id="cost_1">`+data[i].unit_cost+`</td>
				<td class="col-md-2 text-right hidden" id="cost_2"><input type="number" class="form-control input-sm" id="newCost" name="items[`+i+`].amount" onChange="formatItemAdjustment(this)" value="0"></td>
				<td class="col-md-2 text-right hidden" id="cost_3">0</td>
				<td id="lblItemName" style="width:20px"><button class="btn btn-danger fa fa-times" onClick="remove(this)" /></td>
  			</tr>`;
  		}
  		
  		$('#itemsTable tbody').append(html);
  		formatAdjustmentType($("#adjustmentType").val());
  	});
  });
  
submitStockAdjustmentBtn.click(function() {
	
 	var original_text = submitStockAdjustmentBtn.text();
 	submitStockAdjustmentBtn.attr("disabled", "disabled");
 	submitStockAdjustmentBtn.text("Processing....");
 	
 	POST("/api/stock/adjustment", stockAdjustmentForm.serialize(), function(data) {
 		
 		if(data.status != "OK") {
 			displayErrors(data, $("#errors"));
 			submitStockAdjustmentBtn.removeAttr("disabled");
 			submitStockAdjustmentBtn.text(original_text);
 		} else {
 			window.location.replace('/stock/adjustment');
 		}
 	});
});
</script>